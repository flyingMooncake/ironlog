name: Build iOS App

on:
  # Trigger manually from GitHub Actions tab
  workflow_dispatch:

  # Or trigger on push to main branch
  # push:
  #   branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Install dependencies
      working-directory: gym_app
      run: flutter pub get

    - name: Disable code signing in Xcode project
      working-directory: gym_app
      run: |
        # Disable code signing requirements
        sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = ""/g' ios/Runner.xcodeproj/project.pbxproj
        sed -i '' 's/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = "";/g' ios/Runner.xcodeproj/project.pbxproj
        sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' ios/Runner.xcodeproj/project.pbxproj

    - name: Build iOS (no codesign)
      working-directory: gym_app
      run: |
        flutter build ios --release --no-codesign

    - name: Create IPA (unsigned)
      working-directory: gym_app
      run: |
        cd build/ios/iphoneos
        mkdir Payload
        cp -r Runner.app Payload/
        zip -r IronLog.ipa Payload

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: IronLog-iOS
        path: gym_app/build/ios/iphoneos/IronLog.ipa
        retention-days: 30

    - name: Build summary
      run: |
        echo "âœ… iOS build completed!"
        echo "ðŸ“¦ Download the IPA from the Artifacts section"
        echo "ðŸ“± Install using AltStore, Sideloadly, or TrollStore"
