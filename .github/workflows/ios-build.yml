name: Build iOS App

on:
  # Trigger manually from GitHub Actions tab
  workflow_dispatch:

  # Or trigger on push to main branch
  # push:
  #   branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Install dependencies
      working-directory: gym_app
      run: flutter pub get

    - name: Install CocoaPods
      working-directory: gym_app/ios
      run: |
        pod install --repo-update

    - name: Build iOS app with xcodebuild (no code signing)
      working-directory: gym_app/ios
      run: |
        # Build using xcodebuild directly with signing disabled
        xcrun xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -sdk iphoneos \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          PROVISIONING_PROFILE_SPECIFIER="" \
          DEVELOPMENT_TEAM="" \
          clean build \
          | xcpretty || true

    - name: Create IPA (unsigned)
      working-directory: gym_app
      run: |
        # Find the .app bundle in DerivedData or build folder
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "Runner.app" -path "*/Build/Products/Release-iphoneos/*" -type d 2>/dev/null | head -n 1)

        if [ -z "$APP_PATH" ]; then
          echo "Error: Runner.app not found in DerivedData"
          echo "Searching in alternate locations..."
          APP_PATH=$(find . -name "Runner.app" -type d | head -n 1)
        fi

        if [ -z "$APP_PATH" ]; then
          echo "Error: Runner.app not found anywhere"
          exit 1
        fi

        echo "Found Runner.app at: $APP_PATH"

        # Create IPA structure
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        zip -qr IronLog.ipa Payload

        # Verify IPA was created
        ls -lh IronLog.ipa
        echo "IPA created successfully!"

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: IronLog-iOS
        path: gym_app/IronLog.ipa
        retention-days: 30

    - name: Build summary
      run: |
        echo "âœ… iOS build completed!"
        echo "ðŸ“¦ Download the IPA from the Artifacts section"
        echo "ðŸ“± Install using AltStore, Sideloadly, or TrollStore"
