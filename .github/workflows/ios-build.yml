name: Build iOS App

on:
  # Trigger manually from GitHub Actions tab
  workflow_dispatch:

  # Or trigger on push to main branch
  # push:
  #   branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Install dependencies
      working-directory: gym_app
      run: flutter pub get

    - name: Configure Xcode project for unsigned build
      working-directory: gym_app/ios
      run: |
        # Use xcrun to modify build settings
        xcrun xcodebuild -project Runner.xcodeproj \
          -target Runner \
          -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -showBuildSettings > /dev/null

        # Update Info.plist to remove signing requirements
        /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.example.ironlog" Runner/Info.plist || true

    - name: Build iOS app
      working-directory: gym_app/ios
      run: |
        # Build using xcodebuild directly with signing disabled
        xcrun xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -sdk iphoneos \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          clean build

    - name: Create IPA (unsigned)
      working-directory: gym_app/ios
      run: |
        # Find the .app bundle
        APP_PATH=$(find build/Release-iphoneos -name "Runner.app" -type d | head -n 1)

        if [ -z "$APP_PATH" ]; then
          echo "Error: Runner.app not found"
          exit 1
        fi

        # Create IPA structure
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        zip -r ../IronLog.ipa Payload

        # Verify IPA was created
        ls -lh ../IronLog.ipa

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: IronLog-iOS
        path: gym_app/IronLog.ipa
        retention-days: 30

    - name: Build summary
      run: |
        echo "âœ… iOS build completed!"
        echo "ðŸ“¦ Download the IPA from the Artifacts section"
        echo "ðŸ“± Install using AltStore, Sideloadly, or TrollStore"
